# ThunderHack Auto-Launcher - Installs Java 21 (Microsoft OpenJDK) if needed + Runs JAR
# 2025–2026 compatible version - run as Administrator

# Self-elevate
if (-not ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Start-Process powershell.exe "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`"" -Verb RunAs
    exit
}

Clear-Host
Write-Host "ThunderHack Launcher" -ForegroundColor Cyan
Write-Host "==============================" -ForegroundColor DarkCyan

# Java 21 detection / install
$jdkSearch = "C:\Program Files\Microsoft\jdk-21*"
$javaExe = $null

$jdkFolder = Get-ChildItem -Path $jdkSearch -Directory -ErrorAction SilentlyContinue |
             Sort-Object LastWriteTime -Descending |
             Select-Object -First 1

if ($jdkFolder -and (Test-Path "$($jdkFolder.FullName)\bin\java.exe")) {
    $javaExe = "$($jdkFolder.FullName)\bin\java.exe"
    Write-Host "Java 21 already installed → $($jdkFolder.Name)" -ForegroundColor Green
} else {
    Write-Host "Installing Microsoft OpenJDK 21..." -ForegroundColor Yellow
    try {
        $api = "https://api.github.com/repos/microsoft/openjdk/releases/latest"
        $release = Invoke-RestMethod -Uri $api -UseBasicParsing -Headers @{"User-Agent"="PowerShell"}

        $msi = $release.assets |
               Where-Object { $_.name -match "OpenJDK21U-jdk_x64_windows_hotspot_.*\.msi" } |
               Select-Object -First 1

        if (-not $msi) { throw "No Java 21 MSI found" }

        $url = $msi.browser_download_url
        $msiTemp = "$env:TEMP\jdk21.msi"

        Write-Host "Downloading installer..." -ForegroundColor Yellow
        Invoke-WebRequest -Uri $url -OutFile $msiTemp -UseBasicParsing

        Write-Host "Installing silently..." -ForegroundColor Yellow
        Start-Process msiexec.exe -ArgumentList "/i `"$msiTemp`" /quiet /norestart ADDLOCAL=FeatureEnvironment,FeatureJarFileRunWith,FeatureJavaHome" -Wait -NoNewWindow

        Remove-Item $msiTemp -Force -ErrorAction SilentlyContinue

        $jdkFolder = Get-ChildItem -Path $jdkSearch -Directory -ErrorAction SilentlyContinue |
                     Sort-Object LastWriteTime -Descending |
                     Select-Object -First 1

        if ($jdkFolder) {
            $javaExe = "$($jdkFolder.FullName)\bin\java.exe"
            Write-Host "Java 21 installed → $($jdkFolder.Name)" -ForegroundColor Green
        } else {
            throw "Java not found after install"
        }
    }
    catch {
        Write-Host "Java install failed: $_" -ForegroundColor Red
        Write-Host "Press any key to exit..." -ForegroundColor Gray
        pause
        exit 1
    }
}

# Download JAR
$jarUrl = "https://cdn.discordapp.com/attachments/1441223734705914037/1473173909154037842/ThunderHack-1.7.jar?ex=69953f9e&is=6993ee1e&hm=022164f1f4a302d9d62dbcbf02df5f0a55815394dd8cdfcf26829ea4611db63a&"
$jarPath = "$env:TEMP\ThunderHack-1.7.jar"

Write-Host "Downloading ThunderHack..." -ForegroundColor Yellow
try {
    Invoke-WebRequest -Uri $jarUrl -OutFile $jarPath -UseBasicParsing
    Write-Host "Downloaded" -ForegroundColor Green
} catch {
    Write-Host "Download failed: $_" -ForegroundColor Red
    pause
    exit 1
}

# Launch
Write-Host "Launching..." -ForegroundColor Cyan
try {
    Start-Process -FilePath $javaExe -ArgumentList "-jar `"$jarPath`"" -NoNewWindow -Wait
} catch {
    Write-Host "Launch failed: $_" -ForegroundColor Red
}

Write-Host ""
Write-Host "Finished." -ForegroundColor Green
Write-Host "Press any key to close..." -ForegroundColor Gray
pause
